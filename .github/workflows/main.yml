name: Deploy WebApi to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/main.yml"

concurrency:
  group: deploy-webapi
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOTNET_VERSION: "10.0.x"
      RUNTIME: "linux-x64"
      PROJECT_DIR: "backend/WebApi"

      # Local (runner) output folder
      OUT_DIR: "publish_out"

      # Remote folders
      REMOTE_DEPLOY_DIR: "deploy"
      REMOTE_APP_DIR: "web-api"

      # systemd service name
      SERVICE_NAME: "webapi"

      # Env file on the server
      ENV_FILE: "/etc/webapi/.env"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        working-directory: ${{ env.PROJECT_DIR }}
        run: dotnet restore

      - name: Publish (Release)
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          rm -rf "./${OUT_DIR}"
          dotnet publish --configuration Release -o "./${OUT_DIR}" -r "${RUNTIME}"

      # If you use a tool manifest (recommended), this will respect it.
      # Otherwise, it installs dotnet-ef globally for this runner.
      - name: Ensure dotnet-ef is available
        working-directory: backend
        run: |
          if [ -f .config/dotnet-tools.json ]; then
            dotnet tool restore
          else
            dotnet tool install --global dotnet-ef
            echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          fi

      - name: Build migration bundle
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          dotnet ef migrations bundle \
            --configuration Release \
            -o "./${OUT_DIR}/migration-bundle" \
            -r "${RUNTIME}"

      - name: Pack artifacts
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          tar -czf webapi.tgz -C "./${OUT_DIR}" .

      - name: Move artifact to repo root
        run: mv backend/WebApi/webapi.tgz .

      - name: Copy artifact to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "webapi.tgz"
          target: "${{ env.REMOTE_DEPLOY_DIR }}/"
          overwrite: true

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            DEPLOY_DIR="${{ env.REMOTE_DEPLOY_DIR }}"
            APP_DIR="${{ env.REMOTE_APP_DIR }}"
            SERVICE="${{ env.SERVICE_NAME }}"
            ENV_FILE="${{ env.ENV_FILE }}"

            echo "== Ensure directories exist =="
            mkdir -p "$DEPLOY_DIR" "$APP_DIR"

            echo "== Stop service =="
            sudo systemctl stop "$SERVICE"

            echo "== Clear app dir =="
            rm -rf "./$APP_DIR"/*

            echo "== Extract new build into deploy dir =="
            tar -xzf "./$DEPLOY_DIR/webapi.tgz" -C "./$DEPLOY_DIR"
            rm -f "./$DEPLOY_DIR/webapi.tgz"

            echo "== Copy artifacts to app dir =="
            sudo cp -a "./$DEPLOY_DIR"/. "./$APP_DIR"/

            echo "== Ensure migration bundle is executable =="
            sudo chmod +x "./$APP_DIR/migration-bundle"

            echo "== Run migrations with env loaded =="
            bash -lc "set -a; source '$ENV_FILE'; set +a; './$APP_DIR/migration-bundle'"

            echo "== Start service =="
            sudo systemctl start "$SERVICE"

            echo "== Clear deploy dir =="
            rm -rf "./$DEPLOY_DIR"/*
